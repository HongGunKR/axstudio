# -------- Stage 1: Frontend build (npm) --------
FROM node:20-bookworm AS fe
WORKDIR /fe

# Node ë©”ëª¨ë¦¬ ìƒí–¥(ëŒ€ê·œëª¨ ë²ˆë“¤ ëŒ€ë¹„)
ENV NODE_OPTIONS=--max-old-space-size=4096

# lockì´ ìˆìœ¼ë©´ ci, ì—†ìœ¼ë©´ install
COPY src/frontend/package*.json ./src/frontend/
RUN if [ -f src/frontend/package-lock.json ]; then \
      npm -C src/frontend ci; \
    else \
      npm -C src/frontend install; \
    fi

# ì†ŒìŠ¤ ë³µì‚¬ ë° ë¹Œë“œ
COPY src/frontend ./src/frontend
ARG VITE_API_URL=/api
ENV VITE_API_URL=${VITE_API_URL}
RUN npm -C src/frontend run build

# ë¹Œë“œ ì‚°ì¶œë¬¼ í‘œì¤€í™”: dist / build / .next ëª¨ë‘ ì¼€ì´ìŠ¤ ì²˜ë¦¬
RUN set -eux; \
    OUT=/fe/build_out; mkdir -p "$OUT"; \
    if [ -d src/frontend/dist ]; then \
        cp -a src/frontend/dist/. "$OUT/"; \
    elif [ -d src/frontend/build ]; then \
        cp -a src/frontend/build/. "$OUT/"; \
    elif [ -d src/frontend/.next ]; then \
        # Next.jsì¼ ê²½ìš°: ì •ì  ìì‚°ë§Œ ë³µì‚¬(í•„ìš”ì‹œ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ)
        cp -a src/frontend/.next/static "$OUT/"; \
    else \
        echo "âŒ No frontend build output found"; \
        ls -al src/frontend; \
        exit 1; \
    fi

# -------- Stage 2: Backend (Python) --------
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim AS backend
ENV TZ=UTC
WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential gcc g++ make git curl \
    python3-dev libffi-dev libssl-dev cargo \
    && rm -rf /var/lib/apt/lists/*

# ì†ŒìŠ¤ ë³µì‚¬
COPY . /app

# â†“ AstraDB Graph ì»´í¬ë„ŒíŠ¸ ì œê±°
RUN rm -f /app/src/backend/base/langflow/components/vectorstores/astradb_graph.py || true

# Langflowë¥¼ ì†ŒìŠ¤ì—ì„œ ì„¤ì¹˜(+ uvicorn ë“± ì„œë²„ ëŸ°íƒ€ì„ ì˜ì¡´ì„± ê°™ì´)
# (ë£¨íŠ¸/ë² ì´ìŠ¤ uv.lock ë˜ëŠ” pyprojectê°€ ì—†ìœ¼ë©´ --mount ë°”ì¸ë”©ì€ ì‹¤íŒ¨í•˜ë‹ˆ, ë‹¨ìˆœ syncë¡œ ë‘ëŠ” í¸ì´ ì•ˆì „)
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --extra postgresql

# ğŸ”´ Langflowê°€ ê¸°ëŒ€í•˜ëŠ” ê²½ë¡œë¡œ í”„ëŸ°íŠ¸ ì •ì  íŒŒì¼ ë³µì‚¬
#   ë¡œê·¸ì— ë‚˜ì˜¨ ê²ƒì²˜ëŸ¼ í˜„ì¬ ë²„ì „ì€ /app/src/backend/base/langflow/frontend ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
COPY --from=fe /fe/build_out/ /app/src/backend/base/langflow/frontend/

EXPOSE 7860
CMD ["uv", "run", "langflow", "run", "--host", "0.0.0.0", "--port", "7860"]